# Обновление системы экспертизы

## Изменения в структуре

### 1. Обновлены DTO для экспертизы

**Файл: `src/programs/dto/expertise-criteria.dto.ts`**
- Создан новый тип `Criterion` с полями:
  - `value: boolean` - результат проверки критерия
  - `comment?: string` - комментарий к критерию
  - `recommendation?: string` - рекомендация по критерию

**Файл: `src/programs/dto/expertise.dto.ts`**
- Добавлен `SubmitExpertiseDto` с критериями согласно ТЗ:
  - `criterion1_1` до `criterion1_5` - характеристика программы
  - `criterion2_1` до `criterion2_2` - содержание программы
  - `additionalRecommendation` - дополнительные рекомендации
- Удалены старые DTO с числовыми оценками

### 2. Обновлена Entity экспертизы

**Файл: `src/programs/entities/expertise.entity.ts`**
- Заменены числовые поля (relevanceScore, etc.) на JSON поля для критериев
- Добавлены поля `criterion1_1` до `criterion2_2` типа `jsonb`
- Добавлено поле `additionalRecommendation: string | null`
- Поле `isRecommendedForApproval` теперь вычисляется автоматически

### 3. Обновлён сервис экспертизы

**Файл: `src/programs/services/expertise.service.ts`**
- Заменён метод `complete()` на `submit()`
- Удалён метод `update()` 
- Добавлен метод `calculateRecommendation()` - автоматически определяет одобрение
- Добавлен метод `checkFinalDecision()` - проверяет финальное решение по программе
- Удалён метод `calculateTotalScore()` (больше не нужен)
- Удалён метод `createExpertiseConclusion()`
- Удалён метод `resubmitAfterRevision()`

### 4. Обновлён контроллер экспертизы

**Файл: `src/programs/controllers/expertise.controller.ts`**
- Заменён эндпоинт `PATCH /:id` на `POST /:id/submit`
- Удалён эндпоинт `POST /:id/complete`
- Удалён эндпоинт `POST /:programId/resubmit-after-revision`
- Удалён эндпоинт `POST /:id/criteria-conclusion`

### 5. Создана миграция

**Файл: `src/migrations/1756400000000-UpdateExpertiseStructure.ts`**
- Удаляет старые поля с числовыми оценками
- Добавляет новые JSON поля для критериев
- Обновляет структуру таблицы `expertises`

## Логика работы

### Для эксперта:
1. Эксперт получает назначенную экспертизу
2. Заполняет критерии (7 критериев согласно ТЗ):
   - **1.1** Актуальность разработки и реализации программы
   - **1.2** Цель и тема программы соответствуют друг другу  
   - **1.3** Профессиональный стандарт или справочник должностей
   - **1.4** Планируемые результаты обучения (знать/уметь)
   - **1.5** Планируемые результаты обучения по программе
   - **2.1** Содержание программы соответствует теме
   - **2.2** Рабочие программы образовательных модулей
3. Может добавить дополнительные рекомендации
4. Отправляет экспертизу через эндпоинт `POST /expertise/:id/submit`

### Автоматическое принятие решений:
- Если **хоть один** критерий = `false`, программа получает отрицательное заключение
- Решение принимается только после завершения работы **всех 3 экспертов**
- Если хоть у одного эксперта есть отрицательная оценка → программа отправляется на доработку
- Если все 3 эксперта дали положительные оценки → программа одобряется

## API изменения

### Новые эндпоинты:
```
POST /expertise/:id/submit - отправка заполненной экспертизы
```

### Удалённые эндпоинты:
```
PATCH /expertise/:id - обновление экспертизы
POST /expertise/:id/complete - завершение экспертизы  
POST /expertise/:programId/resubmit-after-revision - повторная отправка
POST /expertise/:id/criteria-conclusion - создание заключения
```

### Структура запроса для submit:
```typescript
{
  criterion1_1: { value: true, comment?: "...", recommendation?: "..." },
  criterion1_2: { value: false, comment?: "...", recommendation?: "..." },
  // ... остальные критерии
  additionalRecommendation?: "Дополнительные рекомендации",
  generalFeedback?: "Общий отзыв", 
  conclusion?: "Заключение"
}
```

## Преимущества новой системы:
1. ✅ Простота для экспертов - только boolean значения
2. ✅ Автоматическое принятие решений
3. ✅ Соответствие ТЗ (критерии из таблицы)
4. ✅ Нет сложной логики с числовыми оценками
5. ✅ Чёткие правила: один "нет" = отклонение программы
