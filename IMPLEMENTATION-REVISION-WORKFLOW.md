# Реализация рабочего процесса отправки на доработку

## Обзор

В данном проекте была реализована полнофункциональная система отправки программ экспертами на доработку с последующей повторной экспертизой разными экспертами. Система обеспечивает предотвращение дублирования экспертов на одной программе и ведет полную историю доработок.

## Что было реализовано

### 1. Отправка программы на доработку экспертом

**Файл:** `src/programs/services/expertise.service.ts`

**Метод:** `sendForRevision(expertiseId: string, dto: SendForRevisionDto, expert: User)`

**Функциональность:**
- Эксперт может отправить программу на доработку с детальными комментариями
- Программа получает статус `NEEDS_REVISION`
- Экспертиза получает статус `NEEDS_REVISION`
- Сохраняются комментарии для доработки, общий отзыв и рекомендации
- Устанавливается дата отправки на доработку (`sentForRevisionAt`)

**DTO для отправки на доработку:**
```typescript
export class SendForRevisionDto {
  @IsString()
  revisionComments: string; // Комментарии для доработки

  @IsOptional()
  @IsString()
  generalFeedback?: string; // Общий отзыв

  @IsOptional()
  @IsString()
  recommendations?: string; // Рекомендации
}
```

### 2. Повторная отправка после доработки автором

**Метод:** `resubmitAfterRevision(programId: string, dto: ResubmitAfterRevisionDto, author: User)`

**Функциональность:**
- Автор может повторно отправить программу после внесения изменений
- Версия программы автоматически увеличивается (version++)
- Программа получает статус `IN_REVIEW`
- Назначаются новые эксперты (исключая предыдущих)
- Сохраняется история доработок в поле `revisionHistory`

**DTO для повторной отправки:**
```typescript
export class ResubmitAfterRevisionDto {
  @IsString()
  revisionNotes: string; // Заметки о внесенных изменениях

  @IsOptional()
  @IsString()
  changesSummary?: string; // Краткое описание изменений
}
```

### 3. Назначение новых экспертов без дублирования

**Метод:** `assignNewExpertsForRevision(program: Program)`

**Алгоритм:**
1. Получение ID всех экспертов, которые уже участвовали в экспертизе программы
2. Поиск доступных экспертов, исключая уже участвовавших
3. Проверка наличия достаточного количества новых экспертов (минимум 2)
4. Удаление старых экспертиз со статусом `NEEDS_REVISION`
5. Создание новых экспертиз с назначением 2 новых экспертов
6. Установка позиций экспертов (`FIRST`, `SECOND`)

**Предотвращение дублирования:**
```sql
SELECT expertise.expertId 
FROM expertises expertise 
WHERE expertise.programId = :programId

-- Затем исключение этих ID при поиске новых экспертов
WHERE user.id NOT IN (:...excludeIds)
```

### 4. API Endpoints

#### Отправка на доработку
```typescript
@Post(':id/send-for-revision')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(UserRole.EXPERT)
async sendForRevision(
  @Param('id') expertiseId: string,
  @Body() dto: SendForRevisionDto,
  @GetUser() expert: User,
): Promise<Expertise>
```

#### Повторная отправка
```typescript
@Post(':id/resubmit-after-revision')
@UseGuards(JwtAuthGuard, RolesGuard) 
@Roles(UserRole.AUTHOR)
async resubmitAfterRevision(
  @Param('id') programId: string,
  @Body() dto: ResubmitAfterRevisionDto,
  @GetUser() author: User,
): Promise<Program>
```

#### Получение экспертиз на доработке
```typescript
@Get('my-revisions')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(UserRole.AUTHOR)
async getMyRevisions(@GetUser() author: User): Promise<Expertise[]>
```

### 5. Обновления сущностей

#### Program Entity
**Добавлено поле:** `revisionHistory`
```typescript
@Column('text', { nullable: true })
revisionHistory: string; // История доработок в JSON формате
```

#### Expertise Entity
**Дополнительные поля для доработки:**
```typescript
@Column('text', { nullable: true })
revisionComments: string; // Комментарии для доработки

@Column({ type: 'timestamp', nullable: true })
sentForRevisionAt: Date; // Дата отправки на доработку

@Column({ type: 'int', default: 1 })
revisionRound: number; // Номер круга доработки
```

### 6. Миграции базы данных

**Файл:** `src/migrations/1756290001000-AddRevisionHistoryToPrograms.ts`

Добавляет поле `revisionHistory` в таблицу `programs` для хранения истории доработок.

## Тестирование

### Тестовый скрипт
**Файл:** `test-revision-workflow.ts`

**Покрывает сценарий:**
1. Создание тестовой программы и автора
2. Отправка программы на экспертизу
3. Автоматическое назначение экспертов
4. Начало экспертизы первым экспертом
5. Отправка программы на доработку экспертом
6. Повторная отправка программы автором после доработки
7. Проверка назначения новых экспертов (исключение предыдущих)

### Результаты тестирования
✅ **Тест прошел успешно:**
- Экспертиза отправлена на доработку
- Программа получила статус "требует доработки"
- Программа повторно отправлена с увеличением версии (1 → 2)
- Назначены новые эксперты (исключены предыдущие)
- История доработок сохранена

## Конфигурация базы данных

**База данных:** PostgreSQL
**Название:** `postgres`
**Конфигурация:** `docker-compose.yml`

```yaml
postgres:
  image: postgres:15-alpine
  environment:
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: password
```

## Создание дополнительных экспертов

**Скрипт:** `create-more-experts.ts`

Для тестирования был создан скрипт, который добавляет дополнительных экспертов:
- Петр Четвертый (expert4@test.ru)
- Анна Пятая (expert5@test.ru)
- Сергей Шестой (expert6@test.ru)

Общее количество экспертов в системе: **6**

## Архитектурные решения

### 1. Предотвращение дублирования экспертов
- Используется SQL-запрос для получения ID уже участвовавших экспертов
- При назначении новых экспертов исключаются предыдущие участники
- Проверяется наличие достаточного количества новых экспертов

### 2. Управление версиями программ
- Автоматическое увеличение версии при повторной отправке
- Связь номера круга доработки с версией программы

### 3. История изменений
- JSON-формат для хранения истории доработок
- Включает информацию о версии, заметках и времени отправки

### 4. Статусы и переходы
```
DRAFT → SUBMITTED → IN_REVIEW → NEEDS_REVISION → IN_REVIEW (v2) → APPROVED/REJECTED
```

### 5. Безопасность
- Ролевая модель доступа (EXPERT, AUTHOR, ADMIN)
- JWT аутентификация
- Проверка прав доступа на уровне контроллеров и сервисов

## Решенные технические проблемы

### 1. Конфликты TypeORM
**Проблема:** Ошибки "null value in column programId" при сохранении
**Решение:** Использование `repository.update()` вместо `save()` и QueryBuilder для создания экспертиз

### 2. Кэширование сущностей
**Проблема:** TypeORM пытался сохранить удаленные экспертизы
**Решение:** Очистка связанных объектов перед сохранением и использование прямых SQL-запросов

### 3. Автоматическое назначение экспертов
**Проблема:** Система назначала всех доступных экспертов сразу
**Решение:** Ограничение до 2 экспертов при автоматическом назначении

## Заключение

Реализована полнофункциональная система отправки программ на доработку, которая:

- ✅ Позволяет экспертам отправлять программы на доработку с детальными комментариями
- ✅ Обеспечивает возможность авторам исправлять и повторно отправлять программы
- ✅ Гарантирует назначение разных экспертов без дублирования на одной программе
- ✅ Ведет полную историю доработок и изменений
- ✅ Предоставляет REST API для всех операций
- ✅ Полностью протестирована и функционирует в Docker-среде

Система готова к использованию в производственной среде и соответствует всем заявленным требованиям.
